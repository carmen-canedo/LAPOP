---
title: "Exploring Tidy Data"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

##Lengthening the data set
```{r}
library(tidyverse)
library(devtools)
library(fs)

#Adding questions to column names
long_questions <- function(country, country_before, column){
  #Starting at index 1
  i <- 1
  
  #Makes new list with NA vlaues based on number of columns
  number_for_dupID <- rep(NA, column)
  new_list <- rep(NA, column)
  
  #Replaces original column names with readable version
  while(i <= column){
    #Isolates original column names
    original <- (country$column_name)[i]
#**!!!!! this corrects the lack of label for vb11_10 and adds the appropriate label to its corresponding column, BUT this does not fix the complete problem yet**
    if(original == "vb11_10"){
      correct_label <- "vb11_12"
      new <- attributes(country_before[[correct_label]])$label
      new_list[i] <- new
      i <- i + 1
    }
    else{
    #Replaces with label
    new <- attributes(country_before[[original]])$label
    #Adds object to list
    new_list[i] <- new
    #Moves to next item
    i <- i + 1
    }
  }
  new_list
}

#Function for reducing columns
lengthen <- function(country) {
  country_before <- country
  country <- country %>%
  #These are excluded because they are repeated
  select(-strata,-sex, -jc1rr) %>%
  #Brings together the following columns
  gather(column_name, answer, estratopri:gi7r, -vb11_12)
  #Takes length of column_name and arguments from long_questions
  column <- length(country$column_name)
  questions <- long_questions(country, country_before, column)
  country <- country %>% 
    mutate(questions)
  country <- country %>% 
    select(pais, year, unique_id, column_name, answer, questions, extra_id)
  return(country)
}
```

Working to combine the columns vb11_10 and vb11_12 into vb11_12, they both have data but for different years and need to be put together, but the method below does not work
```{r}
bolivia$vb11_12 <- paste(bolivia$vb11_10, bolivia$vb11_12)
```



##Spreading the data
We need to have a spread version of the tidy data so that it is usable in Tableau Public.
```{r}
library(tidyr)
library(tidyverse)
library(dplyr)

tidy_spread <- function(x){
  x <- x %>%
    #Removing column vb11_12 because it is a duplicate
    select(-column_name, -vb11_12) %>%
    spread(questions, answer)
}
```

##Applying functions to all countries
When I began applying the two functions to the Argentina dataset, the first line ran the error, "attributes are not identical across measure variables; they will be dropped".

The following line of code ran the error, "object 'vb11_12' not found"
```{r}
argentina_long <- lengthen(argentina)
argentina_wide <- tidy_spread(argentina_long)
```


Below, I tried to filter out vb11_12 because it is actually a row, but when I run the argentina_long and wide lines above, it still says the object is not found. I am going to go back up to the lengthen function and see if maybe I can exclue the vb11_12 column from the gather()
#!Do not execute chunk, for reference only
```{r}
tidy_spread <- function(x){
  x <- x %>%
    filter(-vb11_12) %>% 
    select(-column_name) %>%
    spread(questions, answer)
}
```



```{r}
belize_wide <- tidy_spread(lengthen(belize))
brazil_wide <- tidy_spread(lengthen(brazil))
chile_wide <- tidy_spread(lengthen(chile))
panama_wide <- tidy_spread(lengthen(panama))
paraguay_wide <- tidy_spread(lengthen(paraguay))
peru_wide <- tidy_spread(lengthen(peru))
suriname_wide <- tidy_spread(lengthen(suriname))
uruguay_wide <- tidy_spread(lengthen(uruguay))
venezuela_wide <- tidy_spread(lengthen(venezuela))
bolivia_wide <- tidy_spread(lengthen(bolivia))
canada_length <- lengthen(canada)
canada_wide <- tidy_spread(canada_length)
colombia_length <- lengthen(colombia)
colombia_wide <- tidy_spread(colombia_length)
costa_wide <- tidy_spread(lengthen(costa))
ecuador_wide <- tidy_spread(lengthen(ecuador))
elsalvador_wide <- tidy_spread(lengthen(elsalvador))
guatemala_wide <- tidy_spread(lengthen(guatemala))
honduras_wide <- tidy_spread(lengthen(honduras))
mexico_wide <- tidy_spread(lengthen(mexico))
nicaragua_wide <- tidy_spread(lengthen(nicaragua))
usa_wide <- tidy_spread(lengthen(usa))
```


We removed the respective english speaking countries
```{r}
#guyana_wide <- tidy_spread(lengthen(guyana)) Commented out because it is English-only
#jamaica_wide <- tidy_spread(lengthen(jamaica)) Commented out because it is English-only
```

Writing the data set so we can utilize it in other applications
```{r}
write_csv(tidy_data, "tidy_data.csv")
```


```{r}
library(purrr)

countries_2016 <- list(venezuela_2016_17, bolivia_2016_17, brazil_2016_17, canada_2016_17, chile_2016_17, colombia_2016_17,costa_2016_17, ecuador_2016_17, elsalvador_2016_17, guatemala_2016_17, guyana_2016_17, honduras_2016_17, jamaica_2016_17, mexico_2016_17, nicaragua_2016_17, panama_2016_17, paraguay_2016_17, peru_2016_17, usa_2016_17, uruguay_2016_17)

every_2016 <- map_dfr(countries_2016, shrink)
```


Combining all the wide data sets together so that the data can be displayed in Tablau
```{r}
library(tidyr)
library(tidyverse)
library(dplyr)


argentina_and_belize <- bind_rows(argentina_wide, belize_wide)
bolivia_and_brazil <- bind_rows(bolivia_wide, brazil_wide)
canada_and_chile <- bind_rows(canada_wide, chile_wide)
colombia_and_costa <- bind_rows(colombia_wide, costa_wide)
ecuador_and_elsalvador <- bind_rows(ecuador_wide, elsalvador_wide)
guatemala_and_honduras <- bind_rows(guatemala_wide, honduras_wide)
mexico_and_nicaragua <- bind_rows(mexico_wide, nicaragua_wide)
panama_and_peru <- bind_rows(panama_wide, peru_wide)
suriname_and_usa <- bind_rows(suriname_wide, usa_wide)
uruguay_and_venezuela <- bind_rows(uruguay_wide, venezuela_wide)

  
first_four <- bind_rows(argentina_and_belize, bolivia_and_brazil)
second_four <- bind_rows(canada_and_chile, colombia_and_costa)
first_and_second <- bind_rows(first_four, second_four)

third_four <- bind_rows(ecuador_and_elsalvador, guatemala_and_honduras)
third_and_fourth <- bind_rows(third_four, mexico_and_nicaragua)

fifth_four <- bind_rows(panama_and_peru, suriname_and_usa)
sixth_four <- bind_rows(fifth_four, uruguay_and_venezuela)
last <- bind_rows(sixth_four, paraguay)

first_half <- bind_rows(first_and_second, third_and_fourth)

last_combine <- bind_rows(first_half, last)

write_csv(last_combine, "combined_tidy.csv")
```
THIS IS RIGHT
```{r}
library(tidyr)
library(tidyverse)
library(dplyr)

tidy_spread <- function(x){
  x <- x %>% select(-column_name) %>% spread(questions, answer)
}

```


Jesse suspects that we many not have a unique combination of unique id and questions which is causing spread to fail, checking for unique combination of ID and question
```{r}
library(assertr)
argentina_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  assert(is_uniq, unique_question)
```



Let's find all the elements that aren't unique - did this for every country that was not originally functioning and spreading correctly


```{r}
argentina_duplicates <- argentina_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  group_by(unique_question) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 1)

tail(argentina_duplicates)
```


```{r}
bolivia_duplicates <- bolivia_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  group_by(unique_question) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 1)

tail(bolivia_duplicates)
```


```{r}
usa_duplicates <- usa_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  group_by(unique_question) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 1)

tail(usa_duplicates)
```


```{r}
nicaragua_duplicates <- nicaragua_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  group_by(unique_question) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 1)

tail(nicaragua_duplicates)
```


```{r}
honduras_duplicates <- honduras_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  group_by(unique_question) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 1)

tail(honduras_duplicates)
```
