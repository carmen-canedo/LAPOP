---
title: "Exploring Tidy Data"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

##Lengthening the data set
```{r}
library(tidyverse)
library(devtools)
library(fs)


#Is this the same as the function on Questions As Columns?
long_questions <- function(country, country_before, column){
  i <- 1
  new_list <- rep(NA, column)
  while(i <= column){
    spot <- (country$column_name)[i]
    new <- attributes(country_before[[spot]])$label
    new_list[i] <- new
    i <- i + 1
  }
  new_list
}


#Function for reducing columns
lengthen <- function(country) {
  country_before <- country
  country <- country %>%
    #These are excluded because they are repeated
    select(-strata,-sex) %>%
    #Brings together the following columns
    gather(column_name, answer, estratopri:gi7r)
  
  #Takes length of column_name and arguments from long_questions
  column <- length(country$column_name)
  questions <- long_questions(country, country_before, column)
  
  country <- country %>%
    mutate(questions)
  country <- country %>%
    select(pais, year, unique_id, column_name, answer, questions)
  return(country)
}
```


##Spreading the data
We need to have a spread version of the tidy data so that it is usable in Tableau Public.
```{r}
library(tidyr)
library(tidyverse)
library(dplyr)

tidy_spread <- function(x){
  x <- x %>%
    select(-column_name) %>%
    spread(questions, answer)
}
```

##
```{r}
argentina_wide <- tidy_spread(lengthen(argentina))
belize_wide <- tidy_spread(lengthen(belize))
bolivia_wide <- tidy_spread(lengthen(bolivia))
brazil_wide <- tidy_spread(lengthen(brazil))
canada_wide <- stidy_spread(lengthen(canada))
chile_wide <- tidy_spread(lengthen(chile))
colombia_wide <- tidy_spread(lengthen(colombia))
costa_wide <- tidy_spread(lengthen(costa))
ecuador_wide <- tidy_spread(lengthen(ecuador))
elsalvador_wide <- tidy_spread(lengthen(elsalvador))
guatemala_wide <- tidy_spread(lengthen(guatemala))
#guyana_wide <- tidy_spread(lengthen(guyana)) Commented out because it is English-only
honduras_wide <- tidy_spread(lengthen(honduras))
#jamaica_wide <- tidy_spread(lengthen(jamaica)) Commented out because it is English-only
mexico_wide <- tidy_spread(lengthen(mexico))
nicaragua_wide <- tidy_spread(lengthen(nicaragua))
panama_wide <- tidy_spread(lengthen(panama))
paraguay_wide <- tidy_spread(lengthen(paraguay))
peru_wide <- tidy_spread(lengthen(peru))
suriname_wide <- tidy_spread(lengthen(suriname))
usa_wide <- tidy_spread(lengthen(usa))
uruguay_wide <- tidy_spread(lengthen(uruguay))
venezuela_wide <- tidy_spread(lengthen(venezuela))
```


```{r}
write_csv(tidy_data, "tidy_data.csv")
```


```{r}
library(purrr)

countries_2016 <- list(venezuela_2016_17, bolivia_2016_17, brazil_2016_17, canada_2016_17, chile_2016_17, colombia_2016_17,costa_2016_17, ecuador_2016_17, elsalvador_2016_17, guatemala_2016_17, guyana_2016_17, honduras_2016_17, jamaica_2016_17, mexico_2016_17, nicaragua_2016_17, panama_2016_17, paraguay_2016_17, peru_2016_17, usa_2016_17, uruguay_2016_17)

every_2016 <- map_dfr(countries_2016, shrink)
```

```{r}
library(tidyr)
library(tidyverse)
library(dplyr)


argentina_and_belize <- bind_rows(argentina_wide, belize_wide)
bolivia_and_brazil <- bind_rows(bolivia_wide, brazil_wide)
canada_and_chile <- bind_rows(canada_wide, chile_wide)
colombia_and_costa <- bind_rows(colombia_wide, costa_wide)
ecuador_and_elsalvador <- bind_rows(ecuador_wide, elsalvador_wide)
guatemala_and_honduras <- bind_rows(guatemala_wide, honduras_wide)
mexico_and_nicaragua <- bind_rows(mexico_wide, nicaragua_wide)
panama_and_peru <- bind_rows(panama_wide, peru_wide)
suriname_and_usa <- bind_rows(suriname_wide, usa_wide)
uruguay_and_venezuela <- bind_rows(uruguay_wide, venezuela_wide)

  
first_four <- bind_rows(argentina_and_belize, bolivia_and_brazil)
second_four <- bind_rows(canada_and_chile, colombia_and_costa)
first_and_second <- bind_rows(first_four, second_four)

third_four <- bind_rows(ecuador_and_elsalvador, guatemala_and_honduras)
third_and_fourth <- bind_rows(third_four, mexico_and_nicaragua)

fifth_four <- bind_rows(panama_and_peru, suriname_and_usa)
sixth_four <- bind_rows(fifth_four, uruguay_and_venezuela)
last <- bind_rows(sixth_four, paraguay)

first_half <- bind_rows(first_and_second, third_and_fourth)

last_combine <- bind_rows(first_half, last)

write_csv(last_combine, "combined_tidy.csv")
```
THIS IS RIGHT
```{r}
library(tidyr)
library(tidyverse)
library(dplyr)

tidy_spread <- function(x){
  x <- x %>% select(-column_name) %>% spread(questions, answer)
}

```


Jesse suspects that we many not have a unique combination of unique id and questions which is causing spread to fail, checking for unique combination of ID and question
```{r}
library(assertr)
argentina_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  assert(is_uniq, unique_question)
```


Let's find all the elements that aren't unique


```{r}
argentina_duplicates <- argentina_long %>% 
  mutate(unique_question = paste(unique_id, questions)) %>%
  group_by(unique_question) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 1)

tail(argentina_duplicates)
```

